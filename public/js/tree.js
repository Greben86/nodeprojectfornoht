//var clickExpand = function (event) {};function hasClass(elem, className) {    return new RegExp("(^|\\s)"+className+"(\\s|$)").test(elem.className);}function toggleNode(node) {    // определить новый класс для узла    var newClass = hasClass(node, 'ExpandOpen') ? 'ExpandClosed' : 'ExpandOpen';    // заменить текущий класс на newClass    // регексп находит отдельно стоящий open|close и меняет на newClass    var re =  /(^|\s)(ExpandOpen|ExpandClosed)(\s|$)/;    node.className = node.className.replace(re, '$1'+newClass+'$3');}function load(node) {    function showLoading(on) {        var expand = node.getElementsByTagName('DIV')[0];        expand.className = on ? 'ExpandLoading' : 'Expand';    }    function onLoaded(data) {        for(var item of data) {            var divexpand = $('<div>')                    .attr('class', 'Expand')                    .bind('click', function(event){                        clickExpand(event);                    });            var fastlink = $( '<a>' )                    .attr('href', '/catalog/folder/'+item.id)                    .prepend(item.name);            var divcontent = $('<div>')                    .attr('class', 'Content')                    .append(fastlink);                        var listchild = $('<ul>').attr('class', 'Container');                        var listitem = $( '<li>' )                    .attr('class', 'Node Expand'+(item.folder ? 'Closed' : 'Leaf'))                    .attr('id', item.id);                        listitem.append(divexpand).append(divcontent).append(listchild);                        $( node ).find('ul:first').append(listitem);        }        node.isLoaded = true;        toggleNode(node);    }    showLoading(true);    $.ajax({        url: "/catalog/menu/" + node.id,        dataType: "json",        success: function (data) {            if (!data.errcode) {                onLoaded(data);                showLoading(false);            } else {                showLoading(false);            }        },        cache: false    });}clickExpand = function (event) {    event = event || window.event;    var clickedElem = event.target || event.srcElement;    if (!hasClass(clickedElem, 'Expand')) {        return; // клик не там    }    // Node, на который кликнули    var node = clickedElem.parentNode;    if (hasClass(node, 'ExpandLeaf')) {        return; // клик на листе    }    if (node.isLoaded || node.getElementsByTagName('LI').length) {        // Узел уже загружен через AJAX(возможно он пуст)        toggleNode(node);        return;    }    if (node.getElementsByTagName('LI').length) {        // Узел не был загружен при помощи AJAX, но у него почему-то есть потомки        // Например, эти узлы были в DOM дерева до вызова tree()        // Как правило, это "структурные" узлы        // ничего подгружать не надо        toggleNode(node);        return;    }    // загрузить узел    load(node);};